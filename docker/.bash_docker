#!/bin/bash
# --- docker/.bash_docker ---

# Check if docker user and group exists before exporting
# NOTE: PUID 2000 and PGID 2000 are default docker user and group for CSM
if getent passwd docker >/dev/null 2>&1 && getent group docker >/dev/null 2>&1; then
    export dk_uid="$(id -u docker 2>/dev/null)"
    export dk_gid="$(id -g docker 2>/dev/null)"
fi

# Detect if we should use Podman (Common on Fedora/CoreOS)
if command -v podman >/dev/null 2>&1 && ! command -v docker >/dev/null 2>&1; then
    alias docker='podman'
fi

# Check if Container Stack Manager (CSM) is already handled
csm_dir="$HOME/git/container-stack-manager"
stacks_dir='/srv/stacks'

# Docker shortcuts
alias stacks='cd $stacks_dir'

lancheck(){ echo "Container IP: $(docker container exec -it "${*}" wget -qO- ipinfo.io)"; }
vpncheck(){ echo "Container IP: $(docker container exec -it "${*}" wget -qO- ipinfo.io/ip)" && echo "     Host IP: $(wget -qO- ifconfig.me)"; }

# Load CSM or legacy aliases
if [ -d "$csm_dir" ] && command -v csm >/dev/null 2>&1; then
    # Set aliases for use with CSM
    alias csm-cd="cd $csm_dir"
else
    # Set legacy docker aliases
    dcu() { sudo docker compose -f "$stacks_dir/$1/compose.yml" up -d --remove-orphans; }
    dcd() { sudo docker compose -f "$stacks_dir/$1/compose.yml" down; }
    dcb() { dcd "$1" && dcu "$1"; }
    dcl() { sudo docker compose -f "$stacks_dir/$1/compose.yml" logs -f --tail=50; }
    dcn() { local stack="$stacks_dir/$1" && mkdir -p "$stack" && touch "$stack/compose.yml" "$stack/.env"; }
    #     echo "${grn}Created stack structure in ${cyn}$stack${rst}"
    # }
    docker_stack_new(){
        install -o $dk_uid -g $dk_gid -m 774 -d "$stacks_dir/local/${1}"
        install -o $dk_uid -g $dk_gid -m 660 /dev/null "$stacks_dir/local/${1}/compose.yml"
        ln -sf $stacks_dir/local/${1}/.env $stacks_dir/.docker.env
        # install -o 1000 -g 1000 -m 774 "/dev/null $stacks_dir/local/${1}/.env"
        }
    alias dsn='docker_stack_new'

    dks() { cd "$stacks_dir/$1" || echo "${red}Error: Stack not found${rst}"; }

    # dlc() { sudo docker container list --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Image}}"; }
    docker_list_containers(){ docker container list --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.RunningFor}}\t{{.Image}}"; }
    alias dlc="docker_list_containers"

    # docker_compose_up(){ docker compose -f $stacks_dir/${1}/compose.yml up -d --remove-orphans; }
    # alias dcu="docker_compose_up"

    # docker_compose_down(){ docker compose -f $stacks_dir/${1}/compose.yml down; }
    # alias dcd="docker_compose_down"

    # docker_compose_logs(){ docker compose -f $stacks_dir/${1}/compose.yml logs -f --tail=50; }
    # alias dcl="docker_compose_logs"

    # echo "${blu}Loaded legacy Docker aliases (CSM not detected).${rst}"
fi
